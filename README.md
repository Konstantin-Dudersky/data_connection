# data_exchange

## Описание концепции

Цель - предоставить простой обмен данными между различными компонентами программы в системах "околопромышленной" автоматизации. Примеры компонентов:
- компоненты, опрашивающие нижестоящие системы автоматизации, например:
	- OPC UA клиент
	- Modbus TCP клиент
	- Modbus RTU мастер
	- ...
- компоненты, обеспечивающие логику работы программы.
- компоненты, предоставляющие доступ к данным вышестоящим системам, например:
	- HTTP API
	- OPC UA сервер
	- Modbus TCP сервер
	- ...

Сложность возникает в том, что данные могут быть изменены в любом компоненте. Например, значение может быть как в контроллере, так и в интерфейсе пользователя.

Информация между компонентами должна передаваться циклично (насколько это возможно в python) и в полном объеме, в не зависимости от того, были изменения в данных или нет.
- это приводит к большому объему траффика, т.е. компоненты должны быть развернуты на одной системе, или на разных системах, объединённых проводной сетью.
- по сравнению с протоколами, передающими информацию по изменению, упрощается логика, поскольку нет необходимости контролировать успешность передачи информации.

Как должна работать в идеале:
- описывается модель данных
- на паре компонентов, между которыми необходимо настроить связь:
	- создаются объекты соединения, в параметрах которых задаётся адрес противоположной стороны
	- создается объект данных на основе модели и передается в объект соединения
- всё, объекты данных автоматически синхронизируются между собой

## Описание реализации

![docs/schema.svg](docs/schema.svg)

Обмен данными настрававется с двух сторон:
- reader_side - напр., сервис OPC UA клиент. "Читает" данные с полевого уровня и передает на вышестоящие сервисы.
- writer_side - напр. сервис API или Modbus TCP сервер. Данные "записываются" с верхнего уровня из передаются на полевой.

Обозначение областей памяти:
- **xch** (exchange) - заполняется перед передачей (на сервере), или заполняется после передачи (на клиенте). Передача через websocket
- **int** (internal) - промежуточная область. Сохраняется между цилками.
- **ext** (extrenal) - для работы клиентского приложения

writer_side имеет более высокий приоритет, чем reader_side. Например, мы поменяли параметр на стороне writer_side. В этот же момент данные считываются на стороне reader_side. Значение из writer_side будет иметь более высокий приоритет, чем reader_side, если разница между метками времени этих значений будет меньше, чем значение в параметре `writer_priority_delay`.

Реализация построена на базе:
- [fastapi](https://fastapi.tiangolo.com/) - серверная часть передачи данных
- [websockets](https://websockets.readthedocs.io/en/stable/index.html) - клиентская часть передачи данных. Библиотека позволяет также создавать сервер, но поскольку в компонентах будет и так будет использоваться fastapi, поэтому только клиент.
- [pydantic](https://pydantic-docs.helpmanual.io/) - описание модели данных



## Разработка

Установить виртуальное окружение

```sh
poetry install
```

Опубликовать пакет

```sh
poetry build && poetry publish
```
